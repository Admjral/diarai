generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int       @id @default(autoincrement())
  email                 String    @unique
  name                  String
  password              String
  plan                  Plan      @default(Free)
  role                  Role      @default(user)
  subscriptionExpiresAt DateTime?
  subscriptionAutoRenew Boolean   @default(true)
  campaignEdits         CampaignHistory[] @relation("CampaignHistoryAdmin")
  paymentRequests       PaymentRequest[]
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("users")
}

model Lead {
  id            Int        @id @default(autoincrement())
  userId        Int
  name          String
  phone         String
  email         String
  source        String     @default("Другое")
  status        LeadStatus @default(new)
  notes         String?
  campaignId    Int?
  campaign      Campaign?  @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  conversations MessengerConversation[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@map("leads")
}

model Deal {
  id                Int       @id @default(autoincrement())
  userId            Int
  name              String
  clientId          Int?
  clientName        String
  amount            Decimal   @db.Decimal(10, 2)
  currency          String    @default("₸")
  stage             DealStage @default(lead)
  probability       Int       @default(0)
  expectedCloseDate DateTime?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("deals")
}

model Task {
  id          Int          @id @default(autoincrement())
  userId      Int
  title       String
  description String?
  status      TaskStatus   @default(todo)
  priority    TaskPriority @default(medium)
  dueDate     DateTime?
  clientId    Int?
  dealId      Int?
  assignedTo  String?
  tags        String[]     @default([])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("tasks")
}

model Message {
  id        Int           @id @default(autoincrement())
  clientId  Int
  sender    MessageSender
  text      String
  isAI      Boolean       @default(false)
  createdAt DateTime      @default(now())

  @@map("messages")
}

model Campaign {
  id              Int      @id @default(autoincrement())
  userId          Int
  name            String
  platform        String
  status          String   @default("Активна")
  budget          Decimal  @db.Decimal(10, 2)
  spent           Decimal  @default(0) @db.Decimal(10, 2)
  conversions     Int      @default(0)
  imageUrl        String?
  audience        Json?    // Сохраняем данные аудитории (interests, ageRange, adText, recommendations и т.д.)
  rejectionReason String?  // Причина отклонения админом
  leads           Lead[]   // Связь с лидами
  history         CampaignHistory[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("campaigns")
}

model CampaignHistory {
  id          Int            @id @default(autoincrement())
  campaignId  Int
  campaign    Campaign       @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  adminId     Int
  admin       User           @relation("CampaignHistoryAdmin", fields: [adminId], references: [id])
  action      CampaignAction
  fieldName   String?        // Какое поле изменено
  oldValue    Json?          // Старое значение
  newValue    Json?          // Новое значение
  comment     String?        // Комментарий админа
  createdAt   DateTime       @default(now())

  @@index([campaignId])
  @@index([adminId])
  @@map("campaign_history")
}

enum CampaignAction {
  created
  updated
  approved
  rejected
  paused
  activated
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model clients {
  id         Int      @id @default(autoincrement())
  userid_old Int
  name       String
  phone      String
  email      String
  stage      String   @default("Первый контакт")
  status     String   @default("Новый")
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  userId     String   @db.Uuid

  @@index([userid_old], map: "clients_userId_idx")
  @@index([userId], map: "idx_clients_userid_uuid")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model integrations {
  id        Int               @id @default(autoincrement())
  userId    Int
  type      String
  status    IntegrationStatus @default(disconnected)
  config    Json              @default("{}")
  createdAt DateTime          @default(now())
  updatedAt DateTime

  @@unique([userId, type])
  @@index([userId], map: "idx_integrations_userid")
  @@index([userId])
}

enum DealStage {
  lead
  qualification
  proposal
  negotiation
  closed_won
  closed_lost
}

enum IntegrationStatus {
  connected
  disconnected
}

enum LeadStatus {
  new
  contacted
  qualified
  converted
  lost
}

enum MessageSender {
  client
  me
}

enum Plan {
  Free
  Pro
  Business
}

enum Role {
  user
  admin
}

enum TaskPriority {
  low
  medium
  high
  urgent
}

enum TaskStatus {
  todo
  in_progress
  done
  cancelled
}

model Wallet {
  id        Int      @id @default(autoincrement())
  userId    Int
  balance   Decimal  @default(0) @db.Decimal(10, 2)
  currency  String   @default("₸")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([userId])
  @@map("wallets")
}

model SupportTicket {
  id        Int                @id @default(autoincrement())
  userId    Int
  subject   String
  message   String
  status    SupportTicketStatus @default(open)
  priority  SupportTicketPriority @default(medium)
  response  String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  @@index([userId])
  @@map("support_tickets")
}

enum SupportTicketStatus {
  open
  in_progress
  resolved
  closed
}

enum SupportTicketPriority {
  low
  medium
  high
  urgent
}

model Payment {
  id                Int           @id @default(autoincrement())
  userId            Int
  plan              Plan
  amount            Decimal       @db.Decimal(10, 2)
  currency          String        @default("₸")
  status            PaymentStatus @default(pending)
  paymentMethod     String        @default("kaspi")
  kaspiOrderId      String?
  kaspiPaymentId    String?
  walletTransactionId Int?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  paidAt            DateTime?

  @@index([userId])
  @@index([kaspiOrderId])
  @@index([status])
  @@map("payments")
}

model WalletTransaction {
  id            Int             @id @default(autoincrement())
  userId        Int
  walletId      Int
  type          TransactionType
  amount        Decimal         @db.Decimal(10, 2)
  balanceBefore Decimal         @db.Decimal(10, 2)
  balanceAfter  Decimal         @db.Decimal(10, 2)
  description   String?
  paymentId     Int?
  createdAt     DateTime        @default(now())

  @@index([userId])
  @@index([walletId])
  @@index([paymentId])
  @@map("wallet_transactions")
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  cancelled
  refunded
}

enum TransactionType {
  deposit
  withdrawal
  subscription
  refund
}

model Notification {
  id        Int                @id @default(autoincrement())
  userId    Int
  type      NotificationType
  title     String
  message   String
  data      Json?              // Дополнительные данные (например, ID лида, сделки и т.д.)
  read      Boolean            @default(false)
  emailSent Boolean            @default(false)
  pushSent  Boolean            @default(false)
  createdAt DateTime           @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  subscription_expiring
  subscription_expired
  subscription_renewed
  wallet_low_balance
  wallet_deposit
  new_lead
  deal_closed
  task_overdue
  campaign_completed
  payment_success
  payment_failed
  support_response
  system_announcement
  messenger_new_message
  messenger_escalation
}

// ==========================================
// MESSENGER INTEGRATION MODELS
// ==========================================

model MessengerConfig {
  id                 Int      @id @default(autoincrement())
  userId             Int
  type               MessengerType
  credentials        Json     @default("{}") // Зашифрованные credentials
  webhookSecret      String?  // Для верификации webhooks

  // AI Settings
  aiEnabled          Boolean  @default(true)
  aiSystemPrompt     String?  @db.Text
  aiModel            String   @default("gpt-4o-mini")
  aiTemperature      Float    @default(0.7)

  // Escalation Settings
  escalationEnabled  Boolean  @default(true)
  escalationKeywords String[] @default([])

  // Connection Status
  isConnected        Boolean  @default(false)
  lastSyncAt         DateTime?
  sessionId          String?  // Для WhatsApp WAHA session

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([userId, type])
  @@index([userId])
  @@map("messenger_configs")
}

model MessengerConversation {
  id              String   @id @default(cuid())
  userId          Int

  // Идентификация контакта
  messengerId     String   // Телефон (WA), chat_id (TG), PSID (IG)
  messengerType   MessengerType
  contactName     String
  contactPhone    String?
  contactAvatar   String?

  // Последнее сообщение (для списка)
  lastMessage     String?
  lastMessageAt   DateTime?
  unreadCount     Int      @default(0)

  // Статус разговора
  status          ConversationStatus @default(active)

  // Назначение оператору
  assignedToId    Int?

  // Связь с лидом CRM
  leadId          Int?
  lead            Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)

  // AI метрики
  aiResponseCount Int      @default(0)
  escalatedCount  Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  messages        MessengerMessage[]

  @@unique([userId, messengerId, messengerType])
  @@index([userId])
  @@index([status])
  @@index([lastMessageAt])
  @@index([assignedToId])
  @@index([leadId])
  @@map("messenger_conversations")
}

model MessengerMessage {
  id              String   @id @default(cuid())
  conversationId  String
  conversation    MessengerConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Контент
  text            String   @db.Text
  mediaUrls       String[] @default([])

  // Отправитель
  sender          MessageSenderType
  senderName      String?

  // AI метаданные
  isAIGenerated   Boolean  @default(false)
  aiConfidence    Float?
  aiIntent        String?

  // Статус доставки
  status          MessageDeliveryStatus @default(received)
  deliveredAt     DateTime?
  readAt          DateTime?

  // Эскалация
  isEscalated     Boolean  @default(false)
  escalatedAt     DateTime?
  escalationNote  String?

  // Внешний ID (из мессенджера)
  externalId      String?

  createdAt       DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
  @@index([isEscalated])
  @@map("messenger_messages")
}

enum MessengerType {
  whatsapp
  telegram
  instagram
}

enum ConversationStatus {
  active
  archived
  closed
}

enum MessageSenderType {
  customer
  operator
  ai
}

enum MessageDeliveryStatus {
  received
  pending
  sent
  delivered
  read
  failed
}

// ==========================================
// PAYMENT REQUEST MODEL (Kaspi manual payment)
// ==========================================

model PaymentRequest {
  id          Int                   @id @default(autoincrement())
  userId      Int
  user        User                  @relation(fields: [userId], references: [id])
  plan        Plan                  // Pro или Business
  amount      Int                   // 9900 или 24900
  status      PaymentRequestStatus  @default(pending)
  note        String?               // Заметка от клиента
  adminNote   String?               // Заметка от админа
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  processedAt DateTime?             // Когда обработан
  processedBy Int?                  // userId админа который обработал

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("payment_requests")
}

enum PaymentRequestStatus {
  pending   // Ожидает проверки
  approved  // Одобрен (подписка активирована)
  rejected  // Отклонён
}
