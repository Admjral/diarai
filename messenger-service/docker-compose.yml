services:
  # Evolution API - WhatsApp Multi-Session
  # Заменяет WAHA для поддержки множества сессий
  evolution-api:
    image: atendai/evolution-api:latest
    container_name: diarai-evolution-api
    ports:
      - "3001:8080"
    environment:
      # API аутентификация
      - AUTHENTICATION_TYPE=apikey
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY:-change-me}
      # Глобальный webhook для всех instances
      - WEBHOOK_GLOBAL_URL=${MESSENGER_SERVICE_URL:-http://messenger-service:3000}/webhook/whatsapp
      - WEBHOOK_GLOBAL_ENABLED=true
      - WEBHOOK_GLOBAL_WEBHOOK_BY_EVENTS=false
      # События webhook
      - WEBHOOK_EVENTS_MESSAGES_UPSERT=true
      - WEBHOOK_EVENTS_MESSAGES_UPDATE=true
      - WEBHOOK_EVENTS_CONNECTION_UPDATE=true
      - WEBHOOK_EVENTS_QRCODE_UPDATED=true
      - WEBHOOK_EVENTS_SEND_MESSAGE=true
      # База данных (отключена, используем файловое хранилище)
      - DATABASE_ENABLED=false
      # Логирование
      - LOG_LEVEL=ERROR
      - LOG_COLOR=true
      # Настройки instance
      - DEL_INSTANCE=false
      - CONFIG_SESSION_PHONE_CLIENT=DIAR AI
    volumes:
      - evolution_instances:/evolution/instances
      - evolution_store:/evolution/store
    restart: unless-stopped
    networks:
      - messenger-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis для PubSub и кэширования
  redis:
    image: redis:7-alpine
    container_name: diarai-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - messenger-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Messenger Service
  messenger-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: diarai-messenger-service
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      # Evolution API (вместо WAHA)
      - EVOLUTION_API_URL=http://evolution-api:8080
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY:-change-me}
      # Legacy: для обратной совместимости
      - WAHA_URL=http://evolution-api:8080
      # Redis
      - REDIS_URL=redis://redis:6379
      # Backend DIAR
      - DIAR_BACKEND_URL=${DIAR_BACKEND_URL}
      - DIAR_API_KEY=${DIAR_API_KEY}
      # Telegram
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      # Instagram
      - INSTAGRAM_ACCESS_TOKEN=${INSTAGRAM_ACCESS_TOKEN}
      - INSTAGRAM_APP_SECRET=${INSTAGRAM_APP_SECRET}
      - INSTAGRAM_VERIFY_TOKEN=${INSTAGRAM_VERIFY_TOKEN}
      # AI
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      evolution-api:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - messenger-network

volumes:
  evolution_instances:
  evolution_store:
  redis_data:

networks:
  messenger-network:
    driver: bridge
